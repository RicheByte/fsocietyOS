#!/usr/bin/env python3
"""
SMB Vulnerability Exploiter
A script that automates the exploitation of known SMB vulnerabilities (e.g., EternalBlue).
"""

import sys
import subprocess

def run():
    print("\033[92m" + "="*70)
    print("           SMB VULNERABILITY EXPLOITER")
    print("="*70 + "\033[0m\n")
    
    print("\033[91m[!] CRITICAL WARNING: Use only for authorized penetration testing!\033[0m")
    print("\033[91m[!] Unauthorized exploitation is illegal.\033[0m\n")
    
    target = input("\033[97m[?] Enter target IP: \033[0m").strip()
    if not target:
        print("\033[91m[!] No target specified.\033[0m")
        return
    
    print("\n\033[97m[*] SMB Vulnerability Options:\033[0m")
    print("  [1] Check for EternalBlue (MS17-010)")
    print("  [2] SMB Version Detection")
    print("  [3] SMB Share Enumeration")
    print("  [4] Check SMB Signing")
    print("  [5] Full SMB Security Audit")
    
    choice = input("\n\033[95m[?] Select option: \033[0m").strip()
    
    confirm = input("\n\033[93m[?] Confirm you are authorized to test this target (yes/no): \033[0m").strip().lower()
    if confirm != 'yes':
        print("\033[91m[!] Operation cancelled.\033[0m")
        return
    
    if choice == '1':
        print(f"\n\033[92m[*] Checking for EternalBlue vulnerability on {target}...\033[0m\n")
        
        # Using nmap NSE script to check for MS17-010
        cmd = f"nmap -p445 --script smb-vuln-ms17-010 {target}"
        print(f"\033[97m[*] Command: {cmd}\033[0m\n")
        
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=60)
            print(result.stdout)
            
            if "VULNERABLE" in result.stdout:
                print("\033[91m[!] TARGET IS VULNERABLE TO ETERNALBLUE!\033[0m")
            else:
                print("\033[92m[*] Target does not appear vulnerable to EternalBlue\033[0m")
        
        except subprocess.TimeoutExpired:
            print("\033[91m[!] Scan timeout.\033[0m")
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")
    
    elif choice == '2':
        print(f"\n\033[92m[*] Detecting SMB version on {target}...\033[0m\n")
        
        cmd = f"nmap -p445 --script smb-protocols {target}"
        print(f"\033[97m[*] Command: {cmd}\033[0m\n")
        
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
            print(result.stdout)
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")
    
    elif choice == '3':
        print(f"\n\033[92m[*] Enumerating SMB shares on {target}...\033[0m\n")
        
        username = input("\033[97m[?] Enter username (blank for anonymous): \033[0m").strip()
        
        if username:
            password = input("\033[97m[?] Enter password: \033[0m").strip()
            cmd = f"smbclient -L //{target} -U {username}%{password}"
        else:
            cmd = f"smbclient -L //{target} -N"
        
        print(f"\033[97m[*] Command: {cmd}\033[0m\n")
        
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
            print(result.stdout)
            if result.stderr:
                print(f"\033[93m{result.stderr}\033[0m")
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")
    
    elif choice == '4':
        print(f"\n\033[92m[*] Checking SMB signing on {target}...\033[0m\n")
        
        cmd = f"nmap -p445 --script smb-security-mode {target}"
        print(f"\033[97m[*] Command: {cmd}\033[0m\n")
        
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
            print(result.stdout)
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")
    
    elif choice == '5':
        print(f"\n\033[92m[*] Running full SMB security audit on {target}...\033[0m\n")
        
        cmd = f"nmap -p445 --script smb-vuln-* {target}"
        print(f"\033[97m[*] Command: {cmd}\033[0m\n")
        
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=120)
            print(result.stdout)
        except subprocess.TimeoutExpired:
            print("\033[91m[!] Scan timeout.\033[0m")
        except Exception as e:
            print(f"\033[91m[!] Error: {str(e)}\033[0m")
    
    else:
        print("\033[91m[!] Invalid choice.\033[0m")

if __name__ == "__main__":
    run()
